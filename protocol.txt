Протокол обмена с энергомонитором 61850 версия 0.3 alhpa.
 
1. Сетевые параметры. 
Протокол ethernet - TCP/IP с установкой соединения.
Порт - 5025.
Wi-Fi -	ssid:разные, содержат слово atom 
	pasword:12345678
Ip-адрес энергомонитора статический - обычно 192.168.0.30, можно посмотреть/изменить в планшете.

Дополнительно:
	* На энергомониторе запущен dhcp-сервер
	* Блок АЦП и блок синхронизации доступны по статическим адресам <Ip энергомонитора> +
	1 или 2 в четвертом байте адреса, обычно 192.168.0.31 и 192.168.0.32
	соответственно.
	* Все также доступно через входы Ethernet(кроме PTP-шного) на панели энергомонитора, плюс
	потоки 61850-9-2LE.

2. Форматы кодирования.
Все данные передаются в формате little endian. Конвертирование между host и
network byte order не производится.

3. Общий формат пакета.
#	Длина байт		Описание
	2			длина пакета (длина заголовка(3 байта) 
				+ длина данных) (беззнаковое)
	1			код запроса/ответа (команды)
	<длина данных>  данные

Код ответа совпадает с кодом запроса, если ошибка, то старший бит кода
выставляется в 1. Поэтому коды запросов лежат в диапазоне 0 - 127. А коды
ответов 0 - 255.

 4. Список команд.
Код		Описание
2		Запрос состояния потоков
3		Установка времени
4		Запрос текущих параметров блока АЦП
5		Установка параметров блока АЦП
6		Установка отдельных параметров блока АЦП
7		Запрос используемой конфигурации потоков
8		Задание конфигурации потоков 
9		Сканирование сети с выдачей списка обнаруженных потоков
10		Запрос текущих параметров блока синхронизации
11		Задание параметров блока синхронизации
12		Запрос версий ПО прошивок блока АЦП, блока синхронизации и
		энергомонитора	
13		Изменение сетевого адреса
14		Запрос данных для экранной формы компаратора
15		Запрос массива мгновенных значений токов/напряжений
17		Запрос данных для экранной формы мультиметра токов и напряжений
18		Запрос данных для экранных форм мультиметра активных/реактивных мощностей
19		Запрос данных для экранной формы мультиметра углов токов и напряжений
20		Калибровка. Запрос таблицы текущих калибровочных коэффициентов
22		Калибровка. Запрос средних значений токов или напряжений для калибровки
		нуля
23		Калибровка. Запрос действующих значений первой гармоники токов или
		напряжений для калибровки масштабных коэффициентов
24		Калибровка. Запрос углов и частоты токов и напряжений для калибровки угловых
		коэффициентов

5. Формат ответа с сообщением об ошибке.
#	Длина байт	Описание		Значение
	2		длина пакета		3+1	
	1		код команды		код запроса с 1 в старшем бите
	1		код ошибки

#	Код ошибки	Описание
	2		Нет новых данных. Повторите запрос позже.
	3		Данные не доступны, команда невыполнима, либо внутренняя ошибка сервера.

6. Форматы запросов и ответов.
6.1. Запрос состояния потоков (код 2)
6.1.1. Формат запроса
#	Длина байт	Описание		Значение
	2		длина пакета		3	
	1		код команды		2	
6.1.2 Формат ответа
#	Длина байт	Описание		Значение
	2		длина пакета		3+1	
	1		код команды		2
	1		код ответа		1 в 0-м бите - есть поток 1
						1 в 4-м бите есть поток 2

6.2. Установка времени (код 3)
6.2.1. Формат запроса
#	Длина байт	Описание		Значение
	2		длина пакета		3+4
	1		код команды		3
	4		время в секундах,
			начиная с 1970
6.2.2. Формат ответа
#	Длина байт	Описание		Значение
	2		длина пакета		3
	1		код команды		3

6.3. Запрос текущих параметров блока АЦП (код 4)
6.3.1. Формат запроса
#	Длина байт	Описание		Значение
	2		длина пакета		3
	1		код команды		4
6.3.2. Формат ответа
#	Длина байт	Описание		Значение
	2		длина пакета		3+85
	1		код команды		4
	1		предел Ua		от 0 до 9, соответств.:
						1В,2В,5В,10В,30В,60В,120В,240В,480В,800В
	1		предел Ub		..
	1		предел Uc		..
	1		предел Un		..
	1		предел Ia		от 0 до 9, соответств.:
						0.1А,0.25А,0.5А,1А,2.5А,5А,10А,25А,50А,100А
	1		предел Ib		..
	1		предел Ic		..
	1		предел In		..
	6		mac-адрес блока АЦП
	6		mac-адрес назначения
	1		частота дискретизации	0 - 80 точек на период, 
						1 - 256 точек на период
	64		идентификатор потока

6.4. Установка параметров блока АЦП (код 5)
6.4.1. Формат запроса
#	Длина байт	Описание		Значение
	2		длина пакета		3+85
	1		код команды		6
	1		предел Ua		см. 6.3.2
	1		предел Ub		..
	1		предел Uc		..
	1		предел Un		..
	1		предел Ia		..
	1		предел Ib		..
	1		предел Ic		..
	1		предел In		..
	6		mac-адрес блока АЦП
	6		mac-адрес получателя
	1		частота дискретизации	0 - 80 точек на период, 
						1 - 256 точек на период
	64		идентификатор потока
6.4.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3
 	1		код команды			6

6.5. Установка отдельных параметров блока АЦП (код 6)
6.5.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+65
	1		код команды			6
	========= вариант 1 ====================
	1		установить предел		0
	1		сигнал				0x01 - Ia
							0x02 - Ib
							0x04 - Ic
							0x08 - In
							0x10 - Ua
							0x20 - Ub
							0x40 - Uc
							0x80 - Un
	1		предел				см. 6.3.2
	========= вариант 2 ====================
	1		установить			1
			mac-адрес источника
	6		mac-адрес
	========= вариант 3 ====================
	1		установить			2	
			mac-адрес приемника
	6		mac-адрес
	========= вариант 4 ====================
	1		установить			3
			частоту дискретизации
 	1		частота дискретизации		см. 6.3.2
	========= вариант 5 ====================
	1		установить SvID			4
				(идентификатор потока)
	64		SvID				строка
	========= вариант 6 ====================
	1		установить коэффициенты		5
			нуля
	1		маска сигналов			см. Вариант 1
	1		предел				см. 6.3.2
	==== переменная часть ====
	[0..8]*4(int)	значения коэффициентов
			сигналов, указанных
			в маске
	========= вариант 7 ====================
	1		установить коэффициенты		6
			масштаба
	1		маска сигналов			см. Вариант 1
	1		предел				см. 6.3.2
	==== переменная часть ====
	[0..8]*4(float)	значения коэффициентов
			сигналов, указанных
			в маске
	========= вариант 8 ====================
	1		установить угловые		7
			коэффициенты
 	1		маска сигналов			см. Вариант 1
	1		предел				см. 6.3.2
	==== переменная часть ====
	[0..8]*4(float)	значения коэффициентов
			сигналов, указанных
			в маске
6.5.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			6

6.6. Запрос используемой конфигурации потоков (код 7)
6.6.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			7
6.6.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+152
	1		код команды			7
	6		mac-адрес источника 1
	6		mac-адрес получателя		см.61850-9-2LE
	64		идентификатор потока		если пустая строка, то потоком 1 является
							блок АЦП
	6		mac-адрес источника 2
	6		mac-адрес получателя		см.61850-9-2LE
	64		идентификатор потока		если пустая строка, то поток 2 не задан

6.7. Задание конфигурации потоков (код 8)
6.7.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+152	
	1		код команды			8
	6		mac-адрес источника 1
	6		mac-адрес получателя		см.61850-9-2LE
	64		идентификатор потока		если пустая строка, то потоком 1 является
							блок АЦП
	6		mac-адрес источника 2
	6		mac-адрес получателя		см.61850-9-2LE
	64		идентификатор потока		если пустая строка, то поток 2 не задан
6.7.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			8

6.8. Сканирование сети с выдачей списка обнаруженных потоков (код 9)
6.8.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			9
6.8.2. Формат ответа 
#	Длина байт	Описание			Значение
	2		длина пакета			3+4+<число потоков>*(6+6+64)
	1		код команды			9
	4		число потоков			от 0
	6*		mac-адрес источника
	6*		mac-адрес получателя
	64*		идентификатор потока	
				...

6.9. Запрос текущих параметров блока синхронизации (код 10)
6.9.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3	
	1		код команды			10		
6.9.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+51	
	1		код команды			10
	1		входной сигнал			0 - Внутренний кварцевый генератор
							11 - сеть питания 50Гц
							3,4 - 1Гц на вх.PPS фронт
							полож./отриц.
							5,6 - 1Гц на вх.CLK фронт
							полож./отриц.
							Аналогично 1Гц:
							12,13,14,15 - 5МГц
							12,13,14,15 - 5МГц
							18,19,20,21 - 10МГц
							24,25,26,27 - 20МГц
	1		peжим работы 1-го		0 - выключен
			выхода				2 - включен
							3 - включен и инвертирован
	8(double)	частота, Гц
	8(double)	длительность импульса,с
	8(double)	задержка импульса, с
	1		peжим работы 2-го		анлогично Вых1
			выхода
	8(double)	частота, Гц					
	8(double)	длительность импульса,с
	8(double)	задержка импульса, с

6.10. Задание параметров блока синхронизации (код 11)
6.10.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+51
	1		код команды			11
	1		входной сигнал
	1		peжим работы 1-го
			выхода
	8(double)	частота, Гц
	8(double)	длительность импульса,с
	8(double)	задержка импульса, с
	1		peжим работы 2-го
			выхода
	8(double)	частота, Гц					
	8(double)	длительность импульса,с
	8(double)	задержка импульса, с
 
6.10.2. Формат ответа   
#	Длина байт	Описание			Значение
	2		длина пакета			3	
	1		код команды			11

6.11. Запрос версий ПО прошивок блока АЦП, блока синхронизации и
энергомонитора (код 12)
6.11.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			12
6.11.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+72	
	1		код команды			12
	24		версия прошивки			строка
			энергомонитора
	24		версия прошивки			..
			блока АЦП
	24		версия прошивки			..
			блока синхронизации

6.12. Изменeние сетевого адреса (код 13)
6.12.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+48
	1		код команды			13	
	16		Ip-адрес			строка
	16		маска сети			строка
	16		адрес шлюза			строка
6.12.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			13

Внимание:
	Команда также меняет адреса блока АЦП и блока синхронизации
	добавляя соответственно 1 и 2 к последнему байту адресу енергомонитора.

6.13. Калибровка. Запрос таблицы текущих калибровочных коэффициентов (код 20)
6.13.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3
	1		код команды			20
6.13.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+960
	1		код команды			20
	80*4(int)	коэффициенты нуля
	80*4(float) 	масштабные коэффициенты 
	80*4(float)	угловые коэффициенты

6.14. Калибровка. Запрос средних значений токов или напряжений для калибровки нуля (код 22)
6.14.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+18
	1		код команды			22
	16		время				при первом запросе
							массив нулей
							при последующих запросах
							брать из из последнего ответа
							Энергомонитор сравнивает время в запросе с
							временем текущих данных и, если они
							совпадают отвечает ошибкой "данные не
							готовы"
	1		маска сигналов			см. 6.5.1 Вариант 1
			потока 1
	1		маска сигналов			не используется д.б. 0
			потока 2			
6.14.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*<число сигналов>
	1		код команды			22
	16		время
	1		маска сигналов			см. 6.5.1 Вариант 1
			потока 1			определяет также количество значений N
	1		маска сигналов			не используется д.б.0
			потока 2
	======== переменная часть ========
	8(double)	значение 1			значение первого сигнала, чей бит
							выставлен в маске сигналов
					..
	8(double)	значение N

6.15. Калибровка. Запрос действующих значений первой гармоники токов или
напряжений для калибровки масштабных коэффициентов (код 23)
6.15.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+18
	1		код команды			23
	16		время				см. 6.14
	1		маска сигналов			..
			потока 1			..
	1		маска сигналов			..
			потока 2			..
6.15.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*<число сигналов>
	1		код команды			23
	16		время				см. 6.14
	1		маска сигналов			..
			потока 1			..
	1		маска сигналов			..
			потока 2			..
	======== переменная часть ========
	8(double)	значение 1			..
			..				..
	8(double)	значение N			..

6.16. Калибровка. Запрос углов и частоты токов и напряжений для калибровки 
угловых коэффициентов (код 24)
6.16.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+18
	1		код команды			24
	16		время				см. 6.14
 	1		маска сигналов			..
			потока 1			..
	1		маска сигналов			..
			потока 2			..
6.16.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*2*<число сигналов>
	1		код команды			24
	16		время				см. 6.14
	1		маска сигналов			..
			потока 1			..
	1		маска сигналов			..
			потока 2			..
	======== переменная часть ========
	8(double)	угол(радиан) сигнала 1		..
	8(double)	частота(Гц) сигнала 1
 			..				..
	8(double)	угол сигнала N			..
	8(double)	частота сигнала N		..

6.17. Запрос массива мгновенных значений токов/напряжений (код 15)

6.17.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+34	
	1		код команды			15	
	16		время				см. 6.14
	1		маска сигналов			см. 6.5.1 Вариант 1.
			потока 1
	1		маска сигналов			см. 6.5.1 Вариант 1.
			потока 2
	4(uint)		шкала							
	4(uint)		начало
	4(uint)		длина
	4(uint)		максимальное число
			отсчетов одного сигнала

Пояснение:
	Здесь используется масштабная проекция.
	Если, например задать шкалу 10, начало 5 и
	длину 5, то это будет запрос всех значений из второй
	половины секунды. При частоте дискретизации 4000, это
	значения с 2000 по 4000. Если максимальное число отсчетов
	меньше полученного числа отсчетов, то будет 
	произведено прореживание до указанного максимального числа отсчетов.
6.17.2. Формат ответа
#	Длина байт		Описание			Значение
	2			длина пакета			3+18+
								(4 + <число
								отсчетов
								первого
								сигнала>*4 +
								..
								(4 + <число
								отсчетов
								последнего
								сигнала>*4
	1			код команды			15
	16			время				см. 6.14
	1			маска сигналов			см. 6.5.1 Вариант 1.
				потока 1
	1			маска сигналов			см. 6.5.1 Вариант 1.
				потока 2
	======== переменная часть ========
	4(uint)			число отсчетов певого
				выставленного в масках сигнала
	<число_отсчетов>*	отсчеты
	4(float)
				..
	4(uint)			число отсчетов последнего
				выставленного в масках сигнала
	<число_отсчетов>*	отсчеты
	4(float)

6.18. Запрос данных для экранной формы компаратора (код 14)
6.18.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+18
	1		код команды			14
	16		время				см. 6.14
 	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1			
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2			

6.18.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*5*<число сигналов>
	1		код команды			14
	16		время				см. 6.14
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1			
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2
	======== переменная часть ========
	8(double)	действ. значение первого
			выставленного в масках 
			сигнала
	8(double)	среднее значение первого ..
	8(double)	частота 1-ой гармоники ..
	8(double)	абсолютный угол ..
	8(double)	thd ..
			..
	8(double)	действ. значение последнего
			выставленного в масках 
			сигнала
	8(double)	среднее значение последнего ..
	8(double)	частота 1-ой гармоники ..
	8(double)	абсолютный угол ..
	8(double)	thd ..

6.19. Запрос данных для экранной формы мультиметра токов и напряжений (код 17)
6.19.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+20
	1		код команды			17
	16		время				см. 6.14
 	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1			
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2
	1		опорный сигнал потока 1		не используется
	1		опорный сигнал потока 2		не используется
6.19.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*4*<число
							сигналов потока 1>+8*<число
							сочетаний сигналов
							напряжения потока 1>+
							8*4*<число сигналов
							потока 2>+8*<число
							сочетаний сигналов
							напряжения потока 2>
	1		код команды			17
	16		время				см. 6.14
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2 
	======== переменная часть 1 потока 1 ========
	8(double)	действ. значение первого
			выставленного в маске 
			сигнала потока 1
	8(double)	д.з. 1-ой гармоники первого ..
	8(double)	средн. значение ..
	8(double)	thd ..
			..
	======== переменная часть 1 потока 2 ========
			..
	8(double)	действ. значение последнего
			выставленного в маске 
			сигнала потока 2
	8(double)	д.з. 1-ой гармоники последнего ..
	8(double)	средн. значение ..
	8(double)	thd ..
	======== переменная часть 2 потока 1 ========
	8(double)	д.з. разности первого выставленного в
			маске напряжения и второго выставленного
			в маске напряжения потока 1
			..
	======== переменная часть 2 потока 2 ========
			..
	8(double)	д.з. разности предпоследнего выставленного в
			маске напряжения и последнего выставленного
			в маске напряжения потока 2

6.20. Запрос данных для экранных форм мультиметра активной/реактивной мощности (код 18)
6.20.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+20
	1		код команды			18
	16		время				см. 6.14
 	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1			
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2
	1		опорный сигнал потока 1
	1		опорный сигнал потока 2
6.20.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*10*<число
							выставленных фаз
							потока 1> +
							8*10*<число
							выставленных фаз
							потока 2>,
							т.е., например, для
							фазы А должны быть
							выставлены сигналы Ia
							и Ua
	1		код команды			17
	16		время				см. 6.14
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2 
	======== переменная часть потока 1 ========
	8(double)	активная мощность 1-ой 
			выставленной фазы потока 1
	8(double)	реактивная мощность 1-ой ..
	8(double)	суммарная мощность ..
	8(double)	д.з. напряжения ..
	8(double)	д.з. силы тока ..
	8(double)	активная мощность первой 
			гармоники ..
	8(double)	реактивная мощность первой
			гармоники ..
	8(double)	суммарная мощность первой 
			гармоники ..
	8(double)	косинус фи ..
	8(double)	синус фи ..
			..
	======== переменная часть потока 2 ========
			..					
	8(double)	активная мощность последней 
			выставленной фазы потока 2
	8(double)	реактивная мощность послед. ..
	8(double)	суммарная мощность ..
	8(double)	д.з. напряжения ..
	8(double)	д.з. силы тока ..
	8(double)	активная мощность первой 
			гармоники ..
	8(double)	реактивная мощность первой
			гармоники ..
	8(double)	суммарная мощность первой 
			гармоники ..
	8(double)	косинус фи ..
	8(double)	синус фи ..

6.21. Запрос данных для экранной формы мультиметра углов (код 19)
6.21.1. Формат запроса
#	Длина байт	Описание			Значение
	2		длина пакета			3+20
	1		код команды			19
	16		время				см. 6.14
 	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1			
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2
	1		опорный сигнал потока 1		не используется
	1		опорный сигнал потока 2		не используется
6.21.2. Формат ответа
#	Длина байт	Описание			Значение
	2		длина пакета			3+18+8*<число
							выставленных сигналов
							потоков 1 и 2>
	1		код команды			17
	16		время				см. 6.14
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 1
	1		маска сигналов			см. 6.5.1. вариант 1
			потока 2 
	======== переменная часть ========
	8(double)	угол(rad) первой гармоники 1-ого 
			выставленного сигнала потока 1
			..
	8(double)	угол(rad) первой гармоники последнего 
			выставленного сигнала потока 2
